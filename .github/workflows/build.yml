name: builds
on: 
  workflow_dispatch:
  push:
    tags:
      - "build*"

jobs:
  export_game:
    runs-on: "macos-latest"
    # runs-on: self-hosted

    # Add permission for release creation. Can be made narrower according to your needs
    permissions: write-all
    # Job name, can be anything
    name: export game for platforms
    strategy:
      fail-fast: false

    steps:
      # Always include the checkout step so that
      # a project is available for Godot to export
      - name: checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.ACCESS_TOKEN }}

      - name: install the engine
        run: |
          curl -L -o godot.zip https://github.com/godotengine/godot/releases/download/4.3-stable/Godot_v4.3-stable_macos.universal.zip
          unzip godot.zip

      - name: (mac) export game
        id: export
        run: |
          Godot.app/Contents/MacOS/Godot --path "$PWD" --headless --import --versbose --quit
          Godot.app/Contents/MacOS/Godot project.godot --headless --export-release "mac" --quit
          mkdir export/releases
          echo "created export/releases directory"
          zip -r export/releases/macos.zip export/macos.app && echo "arhived mac release"

      - name: (mac) upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: "macos"
          path: "export/releases/macos.zip"

      - name: (windows) export game
        id: export_windows
        run: |
          mkdir export/windows
          echo "created export/windows directory"
          Godot.app/Contents/MacOS/Godot project.godot --headless --export-release "windows" --quit
          zip -r export/releases/windows.zip export/windows
          echo "arhived windows release"

      - name: (windows) upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: "windows"
          path: "export/releases/windows.zip"

      - name: (linux) export game
        id: linux_windows
        run: |
          mkdir export/linux
          echo "created export/linux directory"
          Godot.app/Contents/MacOS/Godot project.godot --headless --export-release "linux" --quit
          zip -r export/releases/linux.zip export/linux
          echo "arhived linux release"
          
      - name: (linux) upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: "linux"
          path: "export/releases/linux.zip"
